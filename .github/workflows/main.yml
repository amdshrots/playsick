# .github/workflows/main.yml

name: macOS Remote Desktop (The Alchemist)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: macos-latest
    timeout-minutes: 350

    steps:
      - name: '1. Install MacPorts and TigerVNC'
        run: |
          echo "Installing MacPorts..."
          # Download and run the official MacPorts installer for the current OS version
          OS_VERSION=$(sw_vers -productVersion | cut -d. -f1-2)
          curl -L -O "https://github.com/macports/macports-base/releases/download/v2.10.0/MacPorts-2.10.0-14-Sonoma.pkg"
          sudo installer -pkg MacPorts-2.10.0-14-Sonoma.pkg -target /

          # Add MacPorts to the PATH
          echo "/opt/local/bin:/opt/local/sbin" | sudo tee -a /etc/paths.d/macports
          export PATH="/opt/local/bin:/opt/local/sbin:$PATH"

          echo "Updating MacPorts..."
          sudo port -v selfupdate

          echo "Installing complete TigerVNC package via MacPorts..."
          # This version is guaranteed to include the server components
          sudo port install tigervnc

          echo "MacPorts installation complete."

      - name: '2. Configure and Launch TigerVNC Server'
        run: |
          echo "::add-mask::${{ secrets.RDP_USER_PASSWORD }}"
          # The PATH must be set again for this new step
          export PATH="/opt/local/bin:/opt/local/sbin:$PATH"

          echo "Configuring VNC password..."
          mkdir -p ~/.vnc
          # The MacPorts executable will be in the PATH now
          echo "${{ secrets.RDP_USER_PASSWORD }}" | tigervncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          echo "Starting TigerVNC server on port 5901..."
          # Start the server compiled by MacPorts
          tigervncserver :1 -localhost no -SecurityTypes VncAuth -PasswordFile ~/.vnc/passwd -fg &
          
      - name: '3. Create Tunnel and Provide Instructions'
        run: |
          echo "Downloading and running bore tunnel..."
          curl -LSs https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-apple-darwin.tar.gz | tar -xz
          chmod +x bore

          echo "Starting bore tunnel for VNC (port 5901)..."
          nohup ./bore local 5901 --to bore.pub > tunnel.log 2>&1 &
          sleep 5

          echo "--------------------------------------------------------------------"
          echo "SESSION IS NOW ACTIVE. THE TRUE PATH IS OPEN."
          cat tunnel.log
          echo "--------------------------------------------------------------------"
          
          sleep 21000
